<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
          content="Distributed Systems, Parallel Programming, Programming Languages and Life">
    <meta name="author" content="Milinda Pathirage">
    <link rel="shortcut icon" href="/images/favicon.png">

    <title>Technology and Life - Handling File Uploads in Clojure Web Apps</title>

    <!-- Google Webfonts -->
    <link href='http://fonts.googleapis.com/css?family=Oswald:300,400,700' rel='stylesheet'
          type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,300italic,400italic,700italic'
          rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Lato:300,400' rel='stylesheet'
          type='text/css'>
    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/main.css">
		
		<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
		<!--[if lt IE 9]>
		  <script src="/js/html5shiv.js"></script>
		  <script src="/js/respond.min.js"></script>
		<![endif]-->
</head>
<body>

<!-- Fixed navbar -->
<div class="navbar navbar-default navbar-fixed-top">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse"
                    data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">TECHNOLOGY & LIFE</a>
        </div>
        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">

            </ul>
            <ul class="nav navbar-nav navbar-right all-caps">
                <li class="active"><a href="/">Home</a></li>
                <li><a href="#about">About</a></li>
                <!--li><a href="#">Photos</a></li>
                <li><a href="#">Archive</a></li-->
            </ul>
        </div>
    </div>
</div>

<div class="container">
    <div class="post">
	<div class="header">
  	<h1>Handling File Uploads in Clojure Web Apps</h1>
  	<p>27 Aug 2012 by Milinda Pathirage</p>
	</div>
	<div class="content">
		<p><a href="http://milinda.pathirage.org/2012/06/06/getting_started_with_clojure_web_application_development/">Clojure web application development</a> is still in it's early stages and there aren't lot of web applications written in Clojure. Recently I had to write add file uploading support to web application I'm developing in Clojure(using <a href="https://github.com/mmcgrana/ring">ring</a> and <a href="https://github.com/weavejester/compojure">compojure</a>). I found following two articles by googling, but those lacks some of the basic internal details.</p>

<ul>
<li><a href="http://nikola.plejic.com/blog/file-upload-in-clojure-compojure/">File upload in Clojure &amp; Compojure</a></li>
<li><a href="http://www.prodevtips.com/2010/12/19/file-uploads-with-clojure-ring-and-compojure/">File uploads with Clojure, Ring and Compojure</a></li>
</ul>


<p>Rest of this post will discuss some of things I have discovered while implementing file upload support.</p>

<p>Below is the code for a simple compojure web application which implements file upload support.</p>

<div class="highlight"><pre><code class="clojure"><span class="p">(</span><span class="kd">ns </span><span class="nv">file-upload.core</span>
  <span class="p">(</span><span class="ss">:use</span> <span class="p">[</span><span class="nv">compojure.core</span><span class="p">]</span>
        <span class="p">[</span><span class="nv">ring.middleware.params</span><span class="p">]</span>
        <span class="p">[</span><span class="nv">ring.middleware.multipart-params</span><span class="p">]</span>
        <span class="p">[</span><span class="nv">ring.adapter.jetty</span><span class="p">]</span>
        <span class="p">[</span><span class="nv">hiccup.core</span><span class="p">]))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">home-page</span> <span class="p">[]</span>
  <span class="p">(</span><span class="nf">html</span> <span class="p">[</span><span class="ss">:form</span> <span class="p">{</span><span class="ss">:action</span> <span class="s">&quot;/file&quot;</span> <span class="ss">:method</span> <span class="s">&quot;post&quot;</span> <span class="ss">:enctype</span> <span class="s">&quot;multipart/form-data&quot;</span><span class="p">}</span>
         <span class="p">[</span><span class="ss">:input</span> <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;file&quot;</span> <span class="ss">:type</span> <span class="s">&quot;file&quot;</span> <span class="ss">:size</span> <span class="s">&quot;20&quot;</span><span class="p">}]</span>
         <span class="p">[</span><span class="ss">:input</span> <span class="p">{</span><span class="ss">:type</span> <span class="s">&quot;submit&quot;</span> <span class="ss">:name</span> <span class="s">&quot;submit&quot;</span> <span class="ss">:value</span> <span class="s">&quot;submit&quot;</span><span class="p">}]]))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">upload-file</span> <span class="p">[</span><span class="nv">file</span><span class="p">]</span>
  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">file-name</span> <span class="p">(</span><span class="nf">file</span> <span class="ss">:filename</span><span class="p">)</span>
        <span class="nv">size</span> <span class="p">(</span><span class="nf">file</span> <span class="ss">:size</span><span class="p">)]</span>
    <span class="p">(</span><span class="nf">do</span>
      <span class="p">(</span><span class="nf">copy</span> <span class="nv">actual-file</span> <span class="p">(</span><span class="nf">File.</span> <span class="p">(</span><span class="nf">format</span> <span class="s">&quot;/Users/milinda/Desktop/%s&quot;</span> <span class="nv">file-name</span><span class="p">)))</span>
      <span class="p">{</span><span class="ss">:status</span> <span class="mi">200</span>
       <span class="ss">:headers</span> <span class="p">{</span><span class="s">&quot;Content-Type&quot;</span> <span class="s">&quot;text/html&quot;</span><span class="p">}</span>
       <span class="ss">:body</span> <span class="p">(</span><span class="nf">html</span> <span class="p">[</span><span class="ss">:h1</span> <span class="nv">file-name</span><span class="p">]</span>
                   <span class="p">[</span><span class="ss">:h1</span> <span class="nv">size</span><span class="p">])})))</span>
  
<span class="p">(</span><span class="nf">defroutes</span> <span class="nv">handler</span>
  <span class="p">(</span><span class="nf">POST</span> <span class="s">&quot;/file&quot;</span> <span class="p">{</span><span class="nv">params</span> <span class="ss">:params</span><span class="p">}</span>
       <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">file</span> <span class="p">(</span><span class="nb">get </span><span class="nv">params</span> <span class="s">&quot;file&quot;</span><span class="p">)]</span>
         <span class="p">(</span><span class="nf">upload-file</span> <span class="nv">file</span><span class="p">)))</span>
       <span class="p">(</span><span class="nf">home-page</span><span class="p">)))</span>

<span class="p">(</span><span class="k">def </span><span class="nv">app</span>
  <span class="p">(</span><span class="nb">-&gt; </span><span class="nv">handler</span>
      <span class="nv">wrap-params</span>
      <span class="nv">wrap-multipart-params</span><span class="p">))</span>
</code></pre></div>


<p>To add file uploading support, you need to wrap your requests using <strong>wrap-multipart-params</strong> middleware which can be found in <strong>ring.middleware.multipart-params</strong> namespace. Previous blog posts I mentioned uses <strong>clojure.contrib.duck-streams</strong> module. That module is deprecated now, instead of duck-streams you can use <strong>clojure.java.io</strong>.</p>

<p>According to my HTML form file input's name is 'file'. From input parameters you can get the 'file' field and it will be a map like following.</p>

<pre><code>      {:size 88855, :tempfile #&lt;File /var/folders/hq/ym6xf4794v7g4hvhll6nmr_c0000gn/T/ring-multipart-4366831661746413539.tmp&gt;, :content-type application/pdf, :filename slides.pdf}
</code></pre>

<p>From that map you can get pointer to the actual file and pther attributes like file size anf file name. Above code shows how you can save uploaded file to anywahere you like.</p>

<p>Complete code can be found in <a href="https://github.com/milinda/ef/tree/master/clojure-web/file-upload">github</a>.</p>

	</div>
</div>

</div>

<div id="footer">
    <div class="container">
        <div id="about" class="row" style="padding-top:20px;">
            <div class="col-lg-6">
                <p>
                    Milinda Pathirage is a Computer Science PhD student at 
					<a href="http://www.iub.edu/" target="_blank">Indiana University,
                    Bloomington</a>. I am interested in distributed systems, parallel programing
                    and many core architectures. <a href="#">More..</a>
                </p>

                <p style="text-transform: uppercase;">
                    <strong>Find me elsewhere</strong>
                </p>

                <div class="social-profiles">
                    <a href="https://twitter.com/milindalakmal">
                        <img src="/images/twitter-32.png">
                    </a>
                    <a href="https://twitter.com/milindalakmal">
                        <img src="/images/facebook-32.png">
                    </a>
                    <a href="https://twitter.com/milindalakmal">
                        <img src="/images/flickr-32.png">
                    </a>
                    <a href="https://twitter.com/milindalakmal">
                        <img src="/images/linkedin-32.png">
                    </a>
                </div>
            </div>
            <div class="col-lg-6">
                <img src="/images/family.png">
            </div>
        </div>
    </div>
		<script src="/js/jquery.min.js"></script>
		<script src="/js/bootstrap.min.js"></script>
</body>
</html>
